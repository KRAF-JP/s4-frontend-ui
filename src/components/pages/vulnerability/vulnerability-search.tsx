import React, { useEffect, useContext, useState } from 'react'
import styled from 'styled-components'
import Color from '../../../const/color'
import { Form, Field } from 'react-final-form'
import SearchToggle from '../../../components/molecules/search-toggle'
import FormField from '../../../components/molecules/form-field'
import { InputText, InputDate, Select } from '../../../components/atoms/form'
import { SearchCheckbox } from '../../../components/atoms/search-checkbox'
import { Button } from '../../../components/atoms/button'
import { Icon } from '../../../components/atoms/icon'
import { IconButton } from '../../../components/atoms/icon-button'
import { useRouter } from 'next/router'
import { useVulnerabilitySearchItem } from '../../../hooks/pages/vulnerability/use-vulnerability'
import GlobalContext from '../../../store/context'

type Props = {
  data?: []
  setData?: any
  searchRef?: any
  setReset?: any
  setListBulkChangeShow?: any
  listBulkChangeShow?: boolean
  handleClick?(e: React.MouseEvent<HTMLElement>): void
}

const defaultSelect = {
  value: '',
  label: 'すべて',
  image: null,
}

const VulnerabilitySearch: React.FC<Props> = (props) => {
  const router = useRouter()
  const [queryInitialValues, setQueryInitialValues] = useState<any>({
    status: [],
    severity: [],
    keyword: '',
  })
  const [userListData, setUserListData] = useState<any>(defaultSelect)
  const [projectDefaultData, setProjectDefaultData] =
    useState<any>(defaultSelect)
  const [serverDefaultData, setServerDefaultData] = useState<any>(defaultSelect)
  const [minDate, setMinDate] = useState<any>()
  const {
    projectList,
    serverList,
    userList,
    assignUserList,
    setTarget,
    setServerRequestTrigger,
  } = useVulnerabilitySearchItem()
  const { state } = useContext(GlobalContext)

  const handleUserChange = (e) => {
    const userId = Number(e.target.value)
    delete router.query.offset
    if (userId) {
      router.push(
        {
          query: { ...router.query, assignee_id: userId },
        },
        undefined,
        { shallow: true }
      )
    } else {
      delete router.query.assignee_id
      router.push(
        {
          query: { ...router.query },
        },
        undefined,
        { shallow: true }
      )
    }
  }

  const handleUserSet = () => {
    setUserListData({
      label: state.user.name,
      value: state.user.id,
      image: state.user.profile_image,
    })
    delete router.query.offset
    router.push(
      {
        query: { ...router.query, assignee_id: state.user.id },
      },
      undefined,
      { shallow: true }
    )
  }

  const handleStatusChange = (formState: any) => {
    const { status } = formState.values
    delete router.query.offset
    router.push(
      {
        query: { ...router.query, 'status[]': status },
      },
      undefined,
      { shallow: true }
    )
  }

  const handleSeverityChange = (formState: any) => {
    const { severity } = formState.values
    delete router.query.offset
    router.push(
      {
        query: { ...router.query, 'severity_id[]': severity },
      },
      undefined,
      { shallow: true }
    )
  }

  const toDoubleDigits = (num) => {
    num += ''
    if (num.length === 1) {
      num = '0' + num
    }
    return num
  }

  const handleStartDateChange = (formValues: any) => {
    const { createStartDate } = formValues.values

    if (!createStartDate) {
      delete router.query.create_date_start
      router.push(
        {
          query: {
            ...router.query,
          },
        },
        undefined,
        { shallow: true }
      )
    } else {
      const year = createStartDate.getFullYear()
      const month = toDoubleDigits(createStartDate.getMonth() + 1)
      const day = toDoubleDigits(createStartDate.getDate())
      setMinDate(createStartDate)

      delete router.query.offset
      router.push(
        {
          query: {
            ...router.query,
            create_date_start: `${year}-${month}-${day}`,
          },
        },
        undefined,
        { shallow: true }
      )
    }
  }

  const handleEndDateChange = (formValues: any) => {
    const { createEndDate } = formValues.values

    if (!createEndDate) {
      delete router.query.create_date_end
      router.push(
        {
          query: {
            ...router.query,
          },
        },
        undefined,
        { shallow: true }
      )
    } else {
      const year = createEndDate.getFullYear()
      const month = toDoubleDigits(createEndDate.getMonth() + 1)
      const day = toDoubleDigits(createEndDate.getDate())

      delete router.query.offset
      router.push(
        {
          query: {
            ...router.query,
            create_date_end: `${year}-${month}-${day}`,
          },
        },
        undefined,
        { shallow: true }
      )
    }
  }

  const handleProjectChange = (e) => {
    if (props.listBulkChangeShow == true) {
      props.setListBulkChangeShow(!props.listBulkChangeShow)
    }
    const projectId = Number(e.target.value)

    delete router.query.offset
    delete router.query.server_id
    setServerDefaultData(defaultSelect)
    if (projectId) {
      router.push(
        {
          query: { ...router.query, project_id: projectId },
        },
        undefined,
        { shallow: true }
      )

      setTarget(projectId)
      setServerRequestTrigger(true)
    } else {
      delete router.query.project_id
      router.push(
        {
          query: { ...router.query },
        },
        undefined,
        { shallow: true }
      )
    }
  }

  const handleServerChange = (e) => {
    const serverId = Number(e.target.value)

    delete router.query.offset
    if (serverId) {
      router.push(
        {
          query: { ...router.query, server_id: serverId },
        },
        undefined,
        { shallow: true }
      )
    } else {
      delete router.query.server_id
      router.push(
        {
          query: { ...router.query },
        },
        undefined,
        { shallow: true }
      )
    }
  }

  let timer = null

  const handleKeywordChange = (formValues: any) => {
    const { keyword } = formValues.values

    clearTimeout(timer)
    timer = setTimeout(() => {
      delete router.query.offset
      if (!keyword) {
        delete router.query.keyword
        router.push(
          {
            pathname: '/vulnerability',
            query: { ...router.query },
          },
          undefined,
          { shallow: true }
        )
      } else {
        router.push(
          {
            pathname: '/vulnerability',
            query: { ...router.query, keyword: keyword },
          },
          undefined,
          { shallow: true }
        )
      }
    }, 2000)
  }

  const queryInitialSet = (query, key) => {
    if (router.query[query]) {
      if (Array.isArray(router.query[query])) {
        const queryList: any = router.query[query]
        const data = queryList.map((data) => {
          return Number(data)
        })

        setQueryInitialValues((state) => ({
          ...state,
          [key]: data,
        }))
      } else {
        setQueryInitialValues((state) => ({
          ...state,
          [key]: [Number(router.query[query])],
        }))
      }
    } else {
      setQueryInitialValues((state) => ({
        ...state,
        [key]: [],
      }))
    }
  }

  const handleClear = () => {
    if (props.listBulkChangeShow == true) {
      props.setListBulkChangeShow(!props.listBulkChangeShow)
    }
    if (!Object.keys(router.query).length) return

    if (router.query.limit) {
      router.push(
        { pathname: '/vulnerability', query: { limit: router.query.limit } },
        undefined,
        { shallow: true }
      )
    } else {
      router.push(
        {
          pathname: '/vulnerability',
        },
        undefined,
        { shallow: true }
      )
    }

    setProjectDefaultData({ label: 'すべて', value: '' })
    setServerDefaultData({ label: 'すべて', value: '' })
    setUserListData({ label: 'すべて', value: '' })
    props.setReset(true)
  }

  useEffect(() => {
    if (router.query.assignee_id) {
      const assignee = userList.filter((data) => {
        return data.value === Number(router.query.assignee_id)
      })

      if (assignee.length) {
        setUserListData(assignee[0])
      }
    }
  }, [router.isReady])

  useEffect(() => {
    queryInitialSet('status[]', 'status')
    queryInitialSet('severity_id[]', 'severity')
  }, [router.isReady, router.query])

  useEffect(() => {
    if (!userList.length) return
    if (router.query.assignee_id) {
      const initialUser = userList.filter((data) => {
        return data.value === Number(router.query.assignee_id)
      })
      setUserListData(initialUser[0])
    }
  }, [router.isReady, userList])

  useEffect(() => {
    if (!projectList.length) return
    if (router.query.project_id) {
      const initialProject = projectList.filter((data) => {
        return data.value === Number(router.query.project_id)
      })
      setProjectDefaultData(initialProject[0])
      setTarget(initialProject[0].value)
      setServerRequestTrigger(true)
    }
  }, [router.isReady, projectList])

  useEffect(() => {
    if (!serverList.length) return
    if (router.query.server_id) {
      const initialServer = serverList.filter((data) => {
        return data.value === Number(router.query.server_id)
      })

      if (initialServer.length !== 0) {
        setServerDefaultData(initialServer[0])
      }
    }
  }, [router.isReady, serverList])

  return (
    <Wrap ref={props.searchRef}>
      <SearchToggle
        height={300}
        handleClick={props.handleClick}
        form={
          <Form
            onSubmit={handleStatusChange}
            initialValues={{
              status: queryInitialValues.status,
              severity: queryInitialValues.severity,
              createStartDate: router.query.create_date_start,
              createEndDate: router.query.create_date_end,
              keyword: router.query.keyword,
            }}
            render={({ handleSubmit, form }) => (
              <form onSubmit={handleSubmit}>
                <FormWrap>
                  <FormWrapRow>
                    <InputWrap>
                      <StyledFormField label={'担当者'}>
                        <Select
                          data={userList}
                          defaultData={userListData}
                          handleClick={handleUserChange}
                        />
                      </StyledFormField>
                      <IconButton handleClick={handleUserSet}>
                        <Icon.User />
                      </IconButton>
                    </InputWrap>

                    <InputWrap>
                      <FormField label={'対応状態'}>
                        <Field name={'status'} type={'checkbox'} value={1}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              icon={<Icon.StatusBacklog />}
                              onChange={(e) => {
                                input.onChange(e)
                                handleStatusChange(form.getState())
                              }}
                            >
                              未対応
                            </SearchCheckbox>
                          )}
                        </Field>
                        <Field name={'status'} type={'checkbox'} value={2}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              icon={<Icon.StatusProgress />}
                              onChange={(e) => {
                                input.onChange(e)
                                handleStatusChange(form.getState())
                              }}
                            >
                              対応中
                            </SearchCheckbox>
                          )}
                        </Field>
                        <Field name={'status'} type={'checkbox'} value={9}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              icon={<Icon.StatusDone />}
                              onChange={(e) => {
                                input.onChange(e)
                                handleStatusChange(form.getState())
                              }}
                            >
                              対応済み
                            </SearchCheckbox>
                          )}
                        </Field>
                        <Field name={'status'} type={'checkbox'} value={3}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              icon={<Icon.StatusClosed />}
                              onChange={(e) => {
                                input.onChange(e)
                                handleStatusChange(form.getState())
                              }}
                            >
                              対応なし
                            </SearchCheckbox>
                          )}
                        </Field>
                      </FormField>
                    </InputWrap>
                  </FormWrapRow>

                  <FormWrapRow>
                    <InputWrap>
                      <FormField label={'深刻度'}>
                        <Field name={'severity'} type={'checkbox'} value={5}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              onChange={(e) => {
                                input.onChange(e)
                                handleSeverityChange(form.getState())
                              }}
                              color={Color.SEVERITY.CRITICAL}
                            >
                              緊急
                            </SearchCheckbox>
                          )}
                        </Field>
                        <Field name={'severity'} type={'checkbox'} value={4}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              onChange={(e) => {
                                input.onChange(e)
                                handleSeverityChange(form.getState())
                              }}
                              color={Color.SEVERITY.HIGH}
                            >
                              重要
                            </SearchCheckbox>
                          )}
                        </Field>
                        <Field name={'severity'} type={'checkbox'} value={3}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              onChange={(e) => {
                                input.onChange(e)
                                handleSeverityChange(form.getState())
                              }}
                              color={Color.SEVERITY.MEDIUM}
                            >
                              警告
                            </SearchCheckbox>
                          )}
                        </Field>
                        <Field name={'severity'} type={'checkbox'} value={2}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              onChange={(e) => {
                                input.onChange(e)
                                handleSeverityChange(form.getState())
                              }}
                              color={Color.SEVERITY.LOW}
                            >
                              注意
                            </SearchCheckbox>
                          )}
                        </Field>
                        <Field name={'severity'} type={'checkbox'} value={1}>
                          {({ input, meta }) => (
                            <SearchCheckbox
                              {...input}
                              onChange={(e) => {
                                input.onChange(e)
                                handleSeverityChange(form.getState())
                              }}
                              color={Color.SEVERITY.INFO}
                            >
                              情報
                            </SearchCheckbox>
                          )}
                        </Field>
                      </FormField>
                    </InputWrap>

                    <InputWrap>
                      <FormField label={'検出日'}>
                        <Field name={'createStartDate'} type={'text'} value={1}>
                          {({ input, meta }) => (
                            <InputDate
                              {...input}
                              onChange={(e) => {
                                input.onChange(e)
                                handleStartDateChange(form.getState())
                              }}
                            />
                          )}
                        </Field>
                        〜&nbsp;&nbsp;
                        <Field name={'createEndDate'} type={'text'} value={1}>
                          {({ input, meta }) => (
                            <InputDate
                              {...input}
                              minDate={minDate}
                              onChange={(e) => {
                                input.onChange(e)
                                handleEndDateChange(form.getState())
                              }}
                            />
                          )}
                        </Field>
                      </FormField>
                    </InputWrap>
                  </FormWrapRow>

                  <FormWrapRow>
                    <InputWrap>
                      <FormField label={'プロジェクト'}>
                        <Select
                          data={projectList}
                          defaultData={projectDefaultData}
                          handleClick={handleProjectChange}
                        />
                      </FormField>
                    </InputWrap>

                    <InputWrap>
                      <FormField label={'サーバー'}>
                        <Select
                          data={serverList}
                          defaultData={serverDefaultData}
                          handleClick={handleServerChange}
                        />
                      </FormField>
                    </InputWrap>

                    <InputWrap>
                      <Field name={'keyword'} type={'text'}>
                        {({ input, meta }) => (
                          <FormField label={'キーワード'}>
                            <InputText
                              {...(input as any)}
                              size={'L'}
                              onKeyUp={(e) => {
                                input.onChange(e)
                                handleKeywordChange(form.getState())
                              }}
                            />
                          </FormField>
                        )}
                      </Field>
                    </InputWrap>

                    <InputWrap>
                      <Button
                        type={'button'}
                        label={'絞り込みをリセット'}
                        small={true}
                        buttonType={'secondary'}
                        handleClick={() => {
                          form.reset()
                          handleClear()
                        }}
                      />
                    </InputWrap>
                  </FormWrapRow>
                </FormWrap>
              </form>
            )}
          />
        }
      />
    </Wrap>
  )
}

const Wrap = styled.div`
  min-width: 1056px;
  margin-top: -40px;
`
const FormWrap = styled.div`
  width: 100%;
  padding-top: 8px;
`
const FormWrapRow = styled.div`
  display: flex;
  text-align: left;
  margin-bottom: 24px;
`
const InputWrap = styled.div`
  display: flex;
  align-items: flex-end;
  margin: 0 32px 0 0;
`
const StyledFormField = styled(FormField)`
  margin-right: 8px;
`

export default VulnerabilitySearch
